name: CI/CD Pipeline

on:
  push:
    branches: [main]
    paths:
      - 'Dockerfile'
      - 'index.html'
      - '**.tf'  # Terraformé–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ã‚‚æ¤œçŸ¥
  pull_request:
    branches: [main]
    paths:
      - '**.tf'

permissions:
  id-token: write
  contents: read
  pull-requests: write # Plançµæœã®ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ã«å¿…è¦

env:
  AWS_REGION: us-west-2
  ECR_REPOSITORY: kadai-app-repo
  AWS_ACCOUNT_ID: "463470960192"

jobs:
  # --- è¦ä»¶1: PRæ™‚ã« Terraform Plan ã‚’ã‚³ãƒ¡ãƒ³ãƒˆ ---
  terraform-plan:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/GitHubActionsRole
          aws-region: ${{ env.AWS_REGION }}

      - uses: hashicorp/setup-terraform@v3
      - name: Terraform Plan
        id: plan
        run: |
          terraform init
          terraform plan -no-color

      - name: Post Plan Comment
        uses: actions/github-script@v7
        with:
          script: |
            const output = `#### Terraform Plan ğŸ“–
            \`\`\`\n
            ${{ steps.plan.outputs.stdout }}
            \`\`\`
            `;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

  # --- è¦ä»¶2 & 3: mainãƒãƒ¼ã‚¸æ™‚ã« Apply ã¨ Dockerãƒ“ãƒ«ãƒ‰/ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿè¡Œ ---
  deploy:
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/GitHubActionsRole
          aws-region: ${{ env.AWS_REGION }}

      # 1. Terraform Apply (ãƒªãƒã‚¸ãƒˆãƒªä½œæˆãªã©)
      - uses: hashicorp/setup-terraform@v3
      - name: Terraform Apply
        run: |
          terraform init
          terraform apply -auto-approve

      # 2. Docker Build and Push
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:latest .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

      # 3. Deploy to EC2 via SSM (ä¿®æ­£æ¸ˆã¿)
      - name: Deploy to EC2 via SSM
        run: |
          aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --targets "Key=tag:Name,Values=tf-handson-web-server" \
            --region ${{ env.AWS_REGION }} \
            --comment "Deploying latest Docker image" \
            --parameters 'commands=[
              "aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com",
              "docker stop app || true",
              "docker rm app || true",
              "docker pull ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY }}:latest",
              "docker run -d -p 80:80 --name app ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY }}:latest"
            ]'